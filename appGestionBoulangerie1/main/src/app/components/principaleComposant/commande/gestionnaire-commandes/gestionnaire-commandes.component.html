<div class="p-3">
  <h2>üì¶ Gestion des Commandes</h2>
  <!-- Filtres -->
  <div class="row mb-3">
    <div class="col-md-3">
      <label class="form-label">Statut :</label>
      <select class="form-select" [(ngModel)]="filtreStatus" (change)="filtrerCommandes()">
        <option value="toutes">Toutes</option>
        <option value="en_attente">En attente</option>
        <option value="en_preparation">En pr√©paration</option>
        <option value="prete">Pr√™te</option>
        <option value="en_livraison">En livraison</option>
        <option value="livr√©e">Livr√©e</option>
      </select>
    </div>
    <div class="col-md-3">
      <label class="form-label">Statut livraison :</label>
      <select class="form-select" [(ngModel)]="filtreStatutLivraison" (change)="filtrerCommandes()">
        <option value="tous">Tous</option>
        <option value="en_preparation">En pr√©paration</option>
        <option value="prete">Pr√™te</option>
        <option value="en_livraison">En livraison</option>
        <option value="livr√©e">Livr√©e</option>
      </select>
    </div>
    <div class="col-md-3">
      <label class="form-label">Recherche :</label>
      <input type="text" class="form-control" placeholder="Client, ID..." [(ngModel)]="recherche" (input)="filtrerCommandes()">
    </div>
    <div class="col-md-3 d-flex align-items-end">
      <button class="btn btn-outline-secondary w-100" (click)="loadCommandes()">
        Actualiser
      </button>
    </div>
  </div>

  <!-- Tableau -->
  <div class="table-responsive">
    <table class="table table-striped table-hover">
      <thead class="table-dark">
        <tr>
          <th (click)="changerTri('id')" style="cursor: pointer;">
            # <i class="bi bi-arrow-down" *ngIf="triColonne === 'id' && triAscendant"></i>
            <i class="bi bi-arrow-up" *ngIf="triColonne === 'id' && !triAscendant"></i>
          </th>
          <th (click)="changerTri('user.name')" style="cursor: pointer;">
            Client <i class="bi bi-arrow-down" *ngIf="triColonne === 'user.name' && triAscendant"></i>
            <i class="bi bi-arrow-up" *ngIf="triColonne === 'user.name' && !triAscendant"></i>
          </th>
          <th (click)="changerTri('montant_total')" style="cursor: pointer;">
            Total <i class="bi bi-arrow-down" *ngIf="triColonne === 'montant_total' && triAscendant"></i>
            <i class="bi bi-arrow-up" *ngIf="triColonne === 'montant_total' && !triAscendant"></i>
          </th>
          <th (click)="changerTri('statut')" style="cursor: pointer;">
            Statut <i class="bi bi-arrow-down" *ngIf="triColonne === 'statut' && triAscendant"></i>
            <i class="bi bi-arrow-up" *ngIf="triColonne === 'statut' && !triAscendant"></i>
          </th>
          <th (click)="changerTri('statut_livraison')" style="cursor: pointer;">
            Livraison <i class="bi bi-arrow-down" *ngIf="triColonne === 'statut_livraison' && triAscendant"></i>
            <i class="bi bi-arrow-up" *ngIf="triColonne === 'statut_livraison' && !triAscendant"></i>
          </th>
          <th (click)="changerTri('created_at')" style="cursor: pointer;">
            Date <i class="bi bi-arrow-down" *ngIf="triColonne === 'created_at' && triAscendant"></i>
            <i class="bi bi-arrow-up" *ngIf="triColonne === 'created_at' && !triAscendant"></i>
          </th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let c of commandesFiltrees">
          <td>{{ c.id }}-  <small class="text-muted d-block">{{ c.user?.telephone }}</small></td>
          <td>M. {{ c.user?.nom }} </td>
          <td>{{ c.total | currency:'EUR' }}</td>
          <td>
            <span class="badge" [ngClass]="{
              'bg-secondary': c.statut === 'en_attente',
              'bg-warning': c.statut === 'en_preparation',
              'bg-info': c.statut === 'prete',
              'bg-primary': c.statut === 'en_livraison',
              'bg-success': c.statut === 'livr√©e'
            }">{{ c.statut }}</span>
          </td>
          <td>
            <span class="badge" [ngClass]="{
              'bg-warning': c.statut_livraison === 'en_preparation',
              'bg-info': c.statut_livraison === 'prete',
              'bg-primary': c.statut_livraison === 'en_livraison',
              'bg-success': c.statut_livraison === 'livr√©e'
            }">{{ c.statut_livraison || 'N/A' }}</span>
          </td>
          <td>{{ c.created_at | date:'dd/MM/yy HH:mm' }}</td>
          <td>
            <div class="btn-group">
              <button class="btn btn-sm btn-outline-primary" (click)="voirDetails(c)">
                D√©tails
              </button>
              <button class="btn btn-sm btn-outline-success" (click)="changerStatut(c, 'en_preparation')"
                *ngIf="c.statut === 'en_attente'">
                Pr√©parer
              </button>
              <button class="btn btn-sm btn-outline-info" (click)="changerStatut(c, 'prete')"
                *ngIf="c.statut === 'en_preparation'">
                Pr√™te
              </button>
              <button class="btn btn-sm btn-outline-warning" (click)="changerStatut(c, 'en_livraison')"
                *ngIf="c.statut === 'prete'">
                Livraison
              </button>
              <button class="btn btn-sm btn-outline-success" (click)="changerStatut(c, 'livree')"
                *ngIf="c.statut === 'en_livraison'">
                Livr√©e
              </button>
              <button class="btn btn-sm btn-outline-secondary" (click)="genererFacture(c.id)"
                *ngIf="!c.facture">
                Facture
              </button>
            </div>
          </td>
        </tr>
        <tr *ngIf="commandesFiltrees.length === 0">
          <td colspan="7" class="text-center text-muted py-4">
            Aucune commande trouv√©e
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  <div class="d-flex justify-content-between align-items-center mt-3" *ngIf="pagination">
    <div>
      <span class="text-muted">
        Affichage de {{ pagination.from }} √† {{ pagination.to }} sur {{ pagination.total }} commandes
      </span>
    </div>
    <nav>
      <ul class="pagination">
        <li class="page-item" [class.disabled]="!pagination.prev_page_url">
          <a class="page-link" (click)="chargerPage(pagination.current_page - 1)">Pr√©c√©dent</a>
        </li>
        <li class="page-item" *ngFor="let page of getPages()" [class.active]="page === pagination.current_page">
          <a class="page-link" (click)="chargerPage(page)">{{ page }}</a>
        </li>
        <li class="page-item" [class.disabled]="!pagination.next_page_url">
          <a class="page-link" (click)="chargerPage(pagination.current_page + 1)">Suivant</a>
        </li>
      </ul>
    </nav>
  </div>
</div>
